use std::{
    collections::HashMap,
    str::FromStr,
    sync::{Arc, Mutex},
};

use crate::{
    error::PaymentError,
    model::{Signer, SignerError},
    signer::{NewError, SdkLwkSigner},
    utils,
    wallet::OnchainWallet,
};
use anyhow::Result;
use bip39::Mnemonic;
use boltz_client::{Keypair, Secp256k1};
use lazy_static::lazy_static;
use lwk_wollet::{
    bitcoin::{
        self,
        bip32::{DerivationPath, Xpriv, Xpub},
    },
    elements::{hex::ToHex, pset::PartiallySignedTransaction, Address, AssetId, Transaction, Txid},
    elements_miniscript::{slip77::MasterBlindingKey, ToPublicKey as _},
    secp256k1::{All, Message},
    WalletTx, WalletTxOut,
};

pub(crate) struct MockWallet {
    signer: SdkLwkSigner,
    utxos: Mutex<Vec<WalletTxOut>>,
}

lazy_static! {
    pub(crate) static ref TEST_LIQUID_TX: Transaction = utils::deserialize_tx_hex("020000000101ad4f1152b3257e081c6f4bc67eef57bae997a152f6e4226454e24b49a45798a70100000000feffffff030bf5295cecc24c0aeb1813e12f974a7a4696a408bbcf4eda4d0270379e5ebd4ecf0934662cadc03364cf7729a25f733cc8999e0f2b12d9ccce3762bd170950e052a103733b0357c226e9b8d56d915ff369f3d10b1089875e358a6453e5a0cf0be0da9f225120110f1e9c0f2dba901ef79b45ebc181d87d86498798f37993f199b64e486aaa980bffc8792431bb1bf5a8a7e307d5fd0883467e2bff3473e1787cc2cf9c7103db6208518b412cf79f6d72e522de8b9c8d208ae00cd805d354c315523002bb2e4520a703e373df7c58aebcc4920f722ba5049f7ff2ec345021bbdace3a86bf8d329a552816001464a066ef48f5f3e1d486b1bac4e928e01ae93ad001499a818545f6bae39fc03b637f2a4e1e64e590cac1bc3a6f6d71aa4443654c140100000000000000fb0000a74a160000000247304402203fc6f037451c1c9b38b90cb788022fa051da1812f310461847cef98583b8d41502205781bf725787978dbe55e343334fc30687b9caccfc249561fd1e529ba987392f01210273aa2eda3cd21dedf796e3058e312c50c8275e674e765ea01c5fda74a288f3b30043010001e78cc52b1ffb6bab378a17f05de5531977b6017cf64a02df2c9b8ba19a376d0828de10fd9cf89db899dbec237feda1c02018f49df8c90a44d8adf63b1c8186ccfd4e1060330000000000000001885baf0128d296357c2c77e7abe462d33c7dc4861519e55d4edf7c4c5ba12fe947457349fd1f0a8b3046df64b1cf4aed94a5b2286a7ac434a34814b6660c8f347b77f06d2daf36cadcbc8c796fbb515c9ad38e6bcab4a66b346a3a1013886341e8cb1c92e7e25029b49091d4feef8d06516db1255a65f0eb55173b35e9b9f16a3825f7a7ca58988bbd9a0d600af8a806c506f911eb78384918d8a230f7dca14af328c84e6e6699679cba3a75cf942ff5d2e45342232377e5912c259e91e12331e3c0a3ec946e812f4dacd1717336633ffa005f29a81cf34b094ef9f74d4941a7b2b21ea6dd8367edaac115de9d2cbf1ea612377bcf784f3c9922a7a55e957734e67d2ed2a9d368f3d07be5fbe89ad3a67e6b53ba14449b2e74ee6b7f8aff85e39a5f09bbd53736a70ea38d32d6de580d723a25dacd8e68b3101cbfc9ff4e98fae44a1cc2bbbf8d5d3248a5157a15d17855a38bb4fa8f13aaaa2d1d3559f6b325c5e2a9b03f7606e40cc899e46534684acab1d3a6037bf2aa3c68f94fb4dbb63619e55d34d966bf596928bfb334191e486e3881096377a18e8c607ca27716cd3b342d761ef2d57d8faa4b833faa0ae449997eb807ddaccbbee97e87a2467a680df95b92d265e20183078976e3091b11330ef23e28fd713f67cc22b9e7752bacf7a01a09952b6e98bb80e7d6874320431a2194e9b5cd3c04316acad19e16201ad3d022eda5cace187b5af331922f9a60fff7468e148ab6164a14c7afa93fde9366d57e82bc4c0e90dea9000d21d6fc731b072fd83781fb6447fbf5c924f5feb70991aafe7ae79aadd436b42fa8deb696d13e8df31e17fe61ddd4d208ff5285347c65ebd0dee50f449ebe083312aec16d5044eaeceea10f749999618ad6cee5010daa0ac0208aff1dcefe2facf533a98184d563790e1b9b764ba8cb37f714f4e5d20801661d49d8c72634fab988584b6f091e18164d388f92b281d0f930b49665a4cd4b996968e9177d5f192d98c2eb930eb26cb024b09d338e24aee44a10e26fa7f96d1210931fe9999120df590f29e0eb279e3054abf330a864e814d56877c155eee1aeb9f40f6550bf472dc4860ca7ca685111d98bd57719a09698e4f610bb7bdf2f3d49729c9b86f095050a48baa000efce2c7bb77f476fba3ae01627337f3626f02771ab370f718208e0ae949c5de969f65456bfc476014af96af1a746aae5ddf1a9d566f8877367aaa906c2c4388bdd1f99993324d6a8391186620ea6e5e7b277ed3ecfee5094d69cf683a61e01a42bbe3bab92faefc18728332984a075598543ac3719a47f0387fac23e6f16badfbed8490f98dce7322382b6a8a08b5c8ebe819f5ed4208f4918017b37b23b32e55494ce359069549bee525713ab377687441ec8b6b3213923437d1acb207377992e753893d1b2a4cbbb3a3ece2a3090178c162f74488699eccc47d62cfb7c985145558fd8076c8075d4318eb9b12f5aeac1a9c7c5ee1d33681b5bb21bc3748b38bea4ac3079282226658fbeb124237aa3c1f317420fb16d6ba551a0739d142f47254a42d7068f2982261b67e46403b5287e4b60f2e3d826f1e527896d9c7748fc9705098716ef670ebc43a204fc19def123610d937f76bf63013e7d818924edec1e81d5f695f80490509e927804c054a2f3c049494402d38e55e693ddd29fb77a87639f77ce58ba951ae91f6587f802f8bb43ce5f2fa73589bcf43b68ca3a8fd9d057ef87d4c8cf7dd29982ae3c288d2f72c8428526daa1d64d9771cc546d275cf87053d045fea2c741d66077327e1a3d5ddf209d9142a7c415d6602109346cb0585b3e612efeb0ac41ff0608e50d69fd66dac26038e3a9436c9d7261ab65bbb49563532383b25e4d96e7f89724fc2e901b79b45e2c7c074aa2775bcf3e49694588ae39e9a6920ff53c94b9a540717f3f3abbf2eeca76fdf7c20f2e4a23ef08629ebf7cfca6c293726f7d59e2c5fc03ea775ae5fbd290e5498bb3d0f8d5e615dee582f74d04c70e67fc612da8d0ee0074e8b3f5e7de4192dbc40dcbb10ad30fd33224b9bb39002be2a407c492662a98d867c7d122bb75809c401a7643ab32722470b919af6b739f3222ea27ba0fececd85285f840b209e266078968fac4a073270b3769e7aef0724ef82468bd4d38cb8d2770156523d6f2ed9801533167951e680711b69a9d18767d0a6dcafa6e4d638b0e19efafb348098a73ba8479cee72f0a7f83e8aaf3d45be4458feef8787e3281d19e1fd84dad83fcc0eba6a4538255769512a1e3cea199f59aa847565c631f26cf47cf1d0fb71392e2dbd3c4611a42d8f437cd7c0dc3632c6c157ea9164e1ffa1c4c45dfe740db354e8b32d73a9f93e355e6a2aef00ab7e906429b4f514ceccc7bc2622a3708441ee1d9a43a1af55bbda78ab980afa05cb14d5504060753f7f595d50c07a9b496a1ab57d630146eff658be229859574ac1be4ab652d6b2039d5b393aa03fdc882c21790db4f6e0fe30c16268100dd55695d0dfc6a91c78a9f2cd09fbba851bae901eb22e946376b8c85617f7114fcca7e65e0a463b9e789ca85be58b9ea65c7008e9b4794ae1422228841c5f5584da495d9061ec7860effa862135daaa93bd26cc5c2ab46bb44404b16e93255ede18e00b7c61ea13a543cf2232e61aaa9adc0e20db069797e35458e9f3f3c6647eeab65cbc9bd5c0848dba44bd0779fdee363e7944bf3b7961b28bb84f18e4317cd19aca0b27295060500d8d119e1e6af3e2179ca990ce93529d8726963968ada3d95761a290053e8aecc91167c67d44762cc23c524af84e0f70d493190d2ea3ad734bcf5ddbd1ecbc6cb0ace2fb3215d7d0914ee1dc111e39559a3cc4ac1177d295ec362d2285a3a8b6b0935600a1ab5bef1c2e31b18c187235dd051be4bad4011ee0abd07539d40fd1649c0f125541c937155cffa90ce018cc57a94d2ea83822356a0f085383df7f4f9664224d0ace4bf0f6d3a27a7849bed2fe0ecb5ed5ddd39aaccce9494e11d832d351e7f4b212936fbb265e00a856a413bd4e6e18e0140817ec6a31d34feb29cebf59efd0736fdf6362a18fe58a089032cc7d5a1a8b3f9881e416235e1952eb2cbd1a3a27ba5ff664227d6537d3c331f565f4c3d2e0f19f1f42b8ad1ed1623cd8fc3e93916accf433ffd30aceeb249b259ab0338e3cfdcb2e8755ca294a22d28344ed1fa8450631bfa6098dae5453ec1ea0cf78768287fe43a068492070dabc826f77ffb5bd3b305cd7d9e0f4128468c160de05fa339172dc6cc906b6da874dc5abf123683074f0c05a4531f3600a6c1a65d78e622582b04cd71fc0a2eaa2e811e8dc0cd00d89c4d9071043eae9e124c131619e37b6d68b0aa1e167bb98f9dec19463b2e1930a39fb67e07a15a7e886a5e62f857007a35d4d687487b693681592d71ab50889543faba7c9047a4c27e47de00bbef32f3b64fa9d0a84712d980423e25632fbdb9e37aa22068e3a0725ba7cc63f5317e8634b87c0ad7ab530ebc2d7899c519964f3570f75f6092a42a26e7d5085326e23b25ef0414126d9168c4c74225e4642682ba58aa459571e3ebd508a451d7387deed43fe10d384eaa6c602c3a4f3a60fe9e08cff85bb031f796dd446d7a2108de04bf06efd7680017311b435bb0d36ccb5cc8d1e85aa6980b278d1bb35f0f9f06cc76ddd9b047089108be63bd628483b026ced478c3aee50e3cfff03d2e0d0e82b797fe217c4fc11e5a510798521a41b22a305c5340c052470755a4a4b1af2e1931877e22fd89238c6712bf1823ed84414e027bf818d09ed493136f8bb5de4c190046f3290c18ac648f6ece727db7548b7916cf566bfbafa20fbeb5d1fc58ffddfb0bdeb258f1aa5979846cd53022946855666ffa061e58c7fa3be9ddd922868779e54c9775ea8c6f8ef9242172d85c097527cd1eeb55bd24dbcde753963b8d33c3e3b835e06286b1af566dfd2b4a0f50f5a713c810103229f9b95a9ecf0fdfc31c4b4b67e65c3ceff9472fe1e015fb08fc38b16d02b8c5f6d31f99bb83bb28d46e8ee7518d006ca6dab24dc35a955e61a0aa5e68087260ee1068776199b54d62b92ba952cb104189e7e04c7379abd702c96a6b92df8f02bd79bb3f93fb5c90827f2216ba723fde14ad8068a50a8f96690f3bdbd06d6004cac2dcb5136a397a5757f69af4e5bcc9ef450566d249d8e28547996c7229807e79741e8c0d8e30b9f42ef89dfbe5706d4088ce461fa7e80e383e1fad7f0fc650993dcc97a307392aee96759df1e026a8f56c0bdef2df064f6849b7049e2d74937e69f444fecbed5d18ec453764a411a5d22b57ce46cd95c95c8c48ac32bd0bce6bd19b2fca228439ddfdd62b51decc20f4340095549bca8520a725a4c669586508f83a49260993c60c0787e9ebc6a97fca288a2b3b0ad1244c508d1050fbfc2b28028d644aae413c495485db5b75323d230a5f4693fbf0ef9f134fbccb452231de5f28271b49c059193f46f1ba16075a2092a3ed171cfd8868fabd21f3d7c42cea5276cddb548236c3943f57fdb852d5ebf8a1a5bdc08f2c6acd6f15c97a3396032ebfbbd3d91442d187847bda801b84edda5687f3d49a14f52e7a3f7baf51a27b88be94b968875b3cd100f7b009ba4da6400b7473cde21a620e1961515757c34b746c5d707ba98c8f54c2fe3c3e11ab44c8aa30485476d43c70b0bffe44b5125c1aa0db1a4298f5e317ea6abafaebca625fbd61d2c7001373cf83893df5cd6cfff6d1505bb65892706f6a65bf3e31e2d413fffc474d7a016604760944a592078bd1d02d677a2e0e9bea91c13ec84f2dfb6dc072ea864b88f2c6cf7a570672f9e316e8cc92ab2c08fe1c068c11c3a154260f3ea0d59eb79d12e198d49da5bb4c0d1ef21ea779e5e185e896a61ad344e03b092ba094ca8d5bbfe95afb1e25f7d2f0c9334740d98baf6c73c9e1a7a1632a8a5646bb045133c3fde473352f1e9fe2f38ce5da8c029ee9a4f31064d97d8b8afae2d813d796ee7914bcfc0191f9575688d199060b11991c5ef38306a7cb2e86bd2f6eb2f7f42f9418d48e7cfe682bb6a6b9f0aa26bb9b6684bf98581e32660676eca8151ddde3f35e662efa044c4f6fbc560b6841cd8231f7be7674eba149442e131953bcf76330f2452c5c4b1d7539ba62a5ddfcb77b2e281f1e28a557a35df9484527c01e3b032570225f95fff811d37babb3349fe1f3efdc8ae766dce4e24c58967579ddc9009b70281e9c01c5651a5cd55ee95e1ccac86286dbdb7ec912a978c68ec6a22daf71073d7280d20d7e6d6072179556d25d31cebce0a557a12093925cdc99889aec6b70b8ce788c420df0e3f03455f8558955899160c7010a6bf01039ed8ffec41a4072f8f1de955e5247c39de2c6e51c90710a46a1dd5e3f3a6d2f95a7b302277483f1497307a29c25100f4caf44d00da52f9ab44292af4485457d388066a14301f6ba64abf07040d14cda6b7ceb1a210d5e8014a712371092ff17ed1f713c4236e3b54bb00ae6c2c3f39c11645ab9edbb5707aee02aa1ad44883f7408491653bc0aa2fee5761425a645d839ced27a80167af762ef97018de64709552c26228897733632744446b640ae704bc349d1d280108b4227eff15f914b3ea58c56d226c64809283ff37931973e78b305609be2f62da8f2836871af1bce9b7cd844130b9bac005276b3d2d737ecdebda3208a6adf4da4c8a3f91a0a4d82c7ffe3a3deeaee7694aff375ca07f0a2ee46d2cdf1eaac43f1a3665843468cc6d4a4ee20011bef4224239e7a41c62cf975dd1eeb60cb1a796f9785fed3a9dcfae80faefed7d436f72db8c7482f3c3a593c2ce6f4f423ce71161d1cbd441025ca18789b9c36b22b7bef9b43010001297558ec8f691f65cc76f4fd40acada6174138c6385451f665ec49b2334ccaf3d78fe140971fe91f59ec675676c66b2368e774277309c607c3b294209050f20dfd4e106033000000000000000115259300d89c137c87dbdf6e59ad3431390fe57f76fd6e330990f5a1b3b642b2bf65cb76aeef001eadae2983192508eb32976ad4db2449da4d28c049e1457f8935ee30791dc50be9cc264d99dfacc8c2b1c8f2efbd2d47f451eb82e48f42cfcba971df515c45681993a373b1ee08e8bdc278bf4652d6304b74fe8d19c763ab3d78db6288b086094152de988256d855f516df4a7eb6b06aff79bcd91830dcb3062d1a4e92a50a416847c04d9d26f36b4d02c37bac43876a7d4a5f02ac1e35fc7e5a8f44df18b1baa1965822fd2348a242b915e818b534106213e685ba1f212c3b77630b3be5f47baecf20092d11409ca27a0c690d6f2d0860e19ff730042993740880fb2eaa5afc32a55b8c4942272e146caee98ba0c8265f9e0ede2728cfcb573406985064def6ec2121b492673498bb556167e5011c9113cdd1ca3852ea368fdcc8dde005a9eb8c8dfeb171e316f3e02e9534f40e482bf93cb51c337022acfe68f8d3bab5374911a56c04c477b9f0fc6796e972e91d2443712f56faf69b3d5348ad0d01ef88272782a1d3acb6ca025bca8905cb5c08b6079ce9307be3755ea6599a2475dc749c0f5078163a6e7aea6419c50e5dd30072a767f5e21809741299b438fecd8b454308f921d5a4157edefbfda18a0be54fc6564972efc04c8ad7308c30fd347d554ad364687e80000c22ac0979971e4981f4b09212f558a84383b2222a7f775ca54ce45238d3a5538be7f21c9f20835a1d0b47bf3dfe01f84848a2aa553efb20655ff41353ca4a22fac61f5a7d119069c2895b0cbc640aa4e997b8f1cb0b726e178b30cace44ec171c3383e0a2d36f9e0666c4e7f87a06455305bdce2a5eee01068a3e863af91e897818cdb4317ce661ab5cc108b80119635b8112771b203d6e21f7649596ac1bfa7f5cd65be756886df4be6e65f89d08d3736577d2dd53610cb43adbef691c77f45b831897e88b03bd33f0e6deda24d439b89e90ec25b632a1476ee04f5d5ed475677e21b01c00672fe01b7631ffb29e2c9c4e9e7f1ae5b9dbc4def83f41023638747f84be5e70abce472daa838d40de4a7f600d23962a29774f46c28b6f541c78c57f4eb53ba734d46aa45b70626876d984e02fe11a904c744f52d36b343467116ca2d5ac36fbe76232f9638241bc0ed7ed1fece77f929df3cda759dad5fed2b773c4577fc8e04475dd020f7d1252f776a89a110b9919c4234d9044a2da7bc146b43e03a7c7d9887f12044a2ca61c15bfdc5d537067e6d00c203a47d132e53aa8ac040bcea77cbcc819be86cae3d1a8aaa7f7bc2832f69effcfe567c13ad7f2fb82a63a478bfd1f6a08b811062be98252ff8899a4a92366ffaee8de837fb75398f27615b2ba0c4ec419c73fa0e6fef2c3d6de615cb2958f4daa68324f93ba12dc7cf325ed59d45ad02f1ca3ab5edd99bdc19b366dea19ec510e12a22fe1533ab8fef5a569035f09f0afeaab3960f51ff6c03b1e192203e098b7b841855e044c6b5c26818deca6f55fcbda26fbdc23225b720f175c089361d695c4e1066006a9c60e457fac07860a11772eee7b1b69cdeb2358f15636adea630406943e40365e9fae820d579098a3b914aa260ef3331b2b875f1cdbddaf8da713b68229e2dd521a6c0408e2a883cbb7c2ba1deafaec861b35b6097d33ccd87aed7de5223dcb714d6fb33f6ca506bde4abef56898649aa2054f27fe6d8604bf66dcd271de6ec4487b4032cc5053e09f786f6fb09d9e29736e5be0af994f81e704720a88aab6240087469f3160146f565d199cdd3ebb93b49faf67d9fae7e683c2307d839a79b2c3997a1a71048fe5609913904b02de3e3e02d990770c90719d4aed6a06e8e42ae6e737fd7436ba332204b31575039c39f8d829f3893c26f7c53cf5b1eb8203761bd130be460568812708ced7ba444963b19e8852c33026e31ad88e52d443d29aa575a730730fd3abf8fba4a0bf5e8af64ba4de9255e0cfb16bf57e42aa1d21766c610fd0838dc1c8ed81b03f837000f538b8c68615499a2fdedb3f07eac95a908732485b79362ba94070c8459106c4f53dc2615e6f618530c37fc5492e0a7e362e117be4c080caaa34c41d3b5168a29b3e89efd06e0e7b3cf19506383d06af41337c0eb6c832a6f8751df091e4461721fbbb01857df41bd17110d4016122a769e37039c1cc684947053d0ac66db1e08cba0130a9e26bf2730d2cba7b7a20eda686a68749bb04b38fb28ae1d1c3a9f37422236e33a7814f61571f9fbd579b095878c4688f22cb14da47c0dfe3b9b385aba06ede469562bd18f19f4e010fc459e4fe99d47f7796fe9fb3fe39886f843c90a108b1d75a4ec61091771cb9334cdc2b85f7ee282142c22c0d9cb54c64759fdcc28547d215c54d1f5d98b266fc5c066811efe79fae460067bb7b7faf150390b9c8481fc28086a4f27e766b426458c39d8d36aa3c9fb4dc5fe25fd651aad1ae43b07dcd77b195ab4e226266fe991bf5b40a0a00992f17141beabee191625199cc8f508a6214e9e0bbf6854313b86222fd50f23a320f27129b0a87d9c71377d7c9ff42df71171353f49ea1662232a504c0121aeab611910eb2d86fdd108fba6fc01684f90ee8290e602f59278d902f3df95012f3b3988d1d78907625693cb811eae25b1aee27525dd89ccfe664b914187ac9a0c194820db231dee5c0d43f4673ef7a110b80c3dbe2c4cfd450ad65934ddae4daa2921bf18fd6ae6c63c767b6eae8fb08bb7b33b0f6563297f0d454f332ea33bac6899d59c8eb17a90a5290e6db44f08c070c3b0b2e8f13e5099d37f1704b3cdf6bdeba51142ec8461996b09921bee59924fea18f2b8cd033b2be2f90b3ea6cbef1ff8aa14583d5c983a44f9e064c65aed45c61879a9d75b96ee6f911900ae894a47b8e22a51f1d66f5091000d6dfe9219c295951f0adc3f6764cd1109f411380ae303af505bf9347238bf0910778983b2900950d9473ceb764a119324a3b323cfcbc661c052840c540c6c595ed7377021a8742fc7835b2cdaf21988f27d9e210f7748c4ac54b758220dc085333291f4767a653a85d7a04541c34557a2e043ab1786b9c41059f62d84ef3d85033fd7581ef5bcc119a81a37a68e02a7ea23f24762ee9751318c1e232536671e0993dc8819584ff4d95fd1aaa539570dba994332dc82842ebcce0806fbf85ce1e1f051b36885a4256b706e15d3844084c70cb64043d5eaefffe662e1eb700e1d58e5908768671e31e8b45f824cc291a1796fbc8abed04515e814db4125313a007b8d1923be44016dd5e8217870b76485d2aeb4991db51c6a1ba2e502f328a90ace24d5c22cdca0f43d980bfba05d4ace2a6c7af71ab809f175d1df3a0f4b344315a8f96be6386e0be955ba8f65f08818b283ba6b8fba153a9996d7db26acd3b300121b0fbe8019e68a8a49c284d72de9d6a398624ca61f0160e7bdb08d778082f8fe6cd8b662943c25743fc4b2ff521690f5213d1252fc994f1ef7865368195210cdc4331a5deed52ecbf0f5cbb1ac05e87d8bd5e70e7eaeb9f0ebc7d594d1c79bde935e6966a625a6ef962c6f89d6a93f4debc135bdd2828a1e5c42c08fb5e9bde2807cc837fa2c86cf80287cec45505758d7d7031b8c6a3d2f44fb0e0f7a47a7320c3ca3f117a7fbcbec93de42854578702a03e3641474c19c9d6e5f2c1beae241d846624bcd0cc9bf065392d23153491355e3cbb39a94aac14e222593c320c337f4116e193522ec06b858693b0e74abddb61733f0c85b355a9500e2c10755b9a2868888d1e0e92bac03db91576c707da7c94dcb8632db2fb2802be63b9471118d2b695cf2d995431bf7d5fc9cd3d96ae7f83ff135d47ab86d6422ef881824dc4dcd248e2aab160b31a9a61c0a73b21a141e3fcc58235099f3fae0230625cef5e4a3629faee9e8128f95f82556a626396a662cb00886261a51032b5f47e7bec6c7f4aa790c46e65ba13137cc887c0bf3d53de82d69bdcdf61cf35415582294442c2dedabc33125078c5225e11d4aac0a4974a0f39a6e3bd7b66050f16fdc5ac69e2991b468710a9b1295173d27a52aa3304b816a590e8c8a9756241474ee374550265aca73711a0cdc8802a484cbc1bac0b678a95a156adaee01c6d5ce4cc0a166d4398d0bd9b878bcf70b038e586127708b67abb17a9e6f876986423c8543421fc882c572efd940cf803924a15847afbfc0b95b032f0a315293b2500ed02b246a057daeb3da3bd6cc90866849a216582172041075c7b0891b619f2f606297b91a45a477bf334d6998b354dd1eb6834241d43274984ccba309755f5ac55a7ee8971e046374977cea1733ece8e635cbc102ce0b3f6da5ea772be5776191f6b9dbbd1d31d02fc19fa9846d3fdda175a861fae4fb6eaa0ee2ab87ac7aeae9c0d42b9f5e8b9557ed9355491afa07e7120cb1c825e0a207955380c5ecc183b647488146f2423097611069dba72873118d127580d2dc93c0f2b821a1a5403c089f0b259b9f285aef80f8d3107ce83052055a1438e01ecc2f836368d4f3148f5687c636cec730e25b007e67349729a0e1d62e0628d42137e131651308695b7b6401d7bcc65ef7f1a3b899d4e9fc40db6ad2ab63bdc88b84e521d8075317e16736c296e6d2a7529dfa4c6fcec74f1e3b3734f5b4e7ce83cec91dd08d9ed05090e2ba5e4a2d5ebaf86f14d6cc1c455c71e3b02aade7bac9ab64c8233d6a7eb7dcc13cd2d24fbe773c42fcac4c64b99bedcca62fa62c1801ed51409a87ebd734794553cc61a0020bda32b84cb525a8b78d7a1c539c97f68512a13fc5fed0a4a880cc6534305b25838b1e7de3ada14799ca58aa91c998cf2353c44300648d42adb6d888dcf776394447437735302c3e634653441178e422007e9c86df14d9055d86114a8a879cdc9cd3686cc583993774a251280236e3a95c32af5e54779f08f118915eae1ac5960ed57aedd1297dc8ac4717293688eed3f72d64d45712ba0ddf66fc5dce4dffe51bcbd00a833ab4bfd77e17eac803f837470a18d8c942c61bf67319961d1e697ebf67d3381d5c7f2ab24f12fea2ce583f76db8e267ba9c623f11dc627bbf50ad2dd04f434d5429d354a57f96e2123f3ba60578fc55e944fbe6fe5c2a516cc4168cf81f7b0b07cea277474a172b005a0490641b5c837a4711a7324a1db8cfa4c02211259882f962cc97b2b8fcf979130ecab33f26b43b332460c12ae78f019f3037f9445ee0e7020d3a28593a944cf0d1b2bd2970e7f6bfe6cbc477b1024b639fb5bc1f4b65db41dc117d2a1b768dcd6be6eb48817912ca85cb8b0fcd66c8e3774cfd8944fd0ca97ed0bc3c636cecb6af378e98681ab89dff70d4425adc76f01dcc850deea73cca83455cf4ad12c5f95d78dd33a46f350beb71950a32c268c81d4e450c6e57debc36a58f5762df7910d82296de452c960be95f119c1e0c18001f14d29628f682150d8d8a6bae08c19c1cc3871a5e832ed2737113bbed761df09ebcc59fe2227fda12b582206cf158bfd320f2690565f6a102481804286f6d26a16df2f8a2ba9b22f64c860749c63a55a024208f7274909c0d46ab0a9c5f5497eff8f734b4d91cc80c3b4936f2fbdeb2dfa7ae66220b59c40fd35abb11ecea40ededa0e52c23e60707cda60b918d12cf1a6aa6d61dbdee847c1dfbd19e6319c8e1f2a35d7d31a622ee9bcbfc6daaf4a69de7c795fc0be6f53b72d4c4121591cf6a3ad3e7692fc65ad6990b33561ef117834e5a229b5c7a9f06c3533a887c35b6cf239421d96a0ff90af23fe2f173ee16f641dc5a6c133c84103d595c07b545190a1b4fbe703c4410a6108d17a55c247696e1deef5fb577171da3a66646c70cdc474c431f8dae0fab6a60000").unwrap();
    pub(crate) static ref TEST_LIQUID_RECEIVE_LOCKUP_TX: Transaction = utils::deserialize_tx_hex("020000000101906c52747017f61cfeb6630d1594f5dde4dc17655dd3c0887554f5c7c33931f50100000000feffffff030bfd01af532f59c76ba8414462d54ed30d2fd7ae945c6c7fdb34ce5d9cf2df6a67082cb9865185d8ba4d1ce9f9a091ecaa5ec66b48089e58bf88c89553ad9fe02e2d03336c0a59188a3880f8eb36a5c459ff1fa164a9654b5b970108f56d3b384623e61600149e69969be27c01b605f9d9d60383707cb0a6d8470bf30e1ae0746f6f2c7d877e8ee7ca2533c0155e9b178ec95563c51b6939a59338089240a83db298f198004f2014f5c2a25b37aa7c7dfca18d75c56ea045ea817e63028161cff50a7d3d859e584f741c4dea5a2bc79d4b64d88990d8d5b4351f65bb322251205ebe70d4595f5db0f5b5b94210d13d4f8cd1e19583da6ab962a4107fcf51796a016d521c38ec1ea15734ae22b7c46064412829c0d0579f0a713d1c04ede979026f01000000000000001a0000e41c310000000247304402206de81bca4d07de5f9e90c2e19e16ac7396fc7dee4b16a16572ba9472abe7215c022022b9aa7c0a1bb116ef62087c10ed97ac3118623b188a998888100a22fb915258012102c28521e6af29a786ce658fc1a39c7f22f00e43bf49adf72af144acd5e245fc700043010001e82fe9e220b7274e054b98d4a50c2b6d95cf2f0b1cc418bd223bc5d6258e0e3ad8da28bbcc47ba76bb0ae2d7fd68dc04f6d4b08d8b952dc9f99241950b074a1afd4e106033000000000000000114cec301f56fd62999d17ada9ecc246d294081107e3e4c2d522a5804d6301e422fdc7699fba4fbeede054691942bf28702ba64ea7328edefc57a4abcc6f1a8fabcd0d6ca6b50d17f1ce363ebd08093947cff884db84591207ce6b2d8a09ddcc636ee908563039ae2d57637b8e7e9275a14a536681c50be33d5523524c5a666b247301ca486024585edae0a0cc1f8a5e3ebfd8be9fd7e118d59653b14059051a5e0486d52a7e38b351566274bb49fba7fdb13bd725e12ddbc565498daceb458cad23741f5de36674d19267760f7a33e549dc81ca684860a170e2fd4b1675e9ad280b779f88ce28f32d43392f010706d03fd38b9585e91ece3130c0973054387c753fa62bc303555b5f739fb98384cedd58cfbaaef1fca1b9698f9713a8da5ee8063ab29bdf4cbbf13f4a917306b278babc287f76844bc74ba324d74da8a06e3d4d09765ae9e3ab87f23a8aec7d04fcbd047aefd28d5424675a989f5960ed50165433bf9e62c93e34075cd1656743ccae4d94ad0b2ae83ba50fdaf8e814fd811d2bb9e809a03c0105c74978be83d88574962385c2ac786582c3dcad6f0d18b11b84b014887ccb1b92f20c5c44647c7a28de7df2d114a474a90ff3cc8d673281a38222d37877e2ca06b6daa0ff07372b298dbf2cddced56cd677a356e1f2b04355b8212c9d73f203b1f88bdfdbd6c5d8e0c9605e482fcd8bbb4c6ed0f73b8706c3cd9dd13ea3227393865074842ce3037140e35830363c86d2055a0cfa2c612b2c9063e9916da419b5eb4e639648047f570063f41f4fd77a234eb7ed19a189284a44b88ac760dc6a358cfefced7c5a8078977d813e32a0a5a6b141ced80c9f632cf7b41809c29de591042c6f59f9c701e6266b4c9bdaa5817d68a78e774a94445662330bc9c00a061bfdc3b6fa185c5bd20143e0f0cefd9f3dbe5f9e5feb398c6b5a76014c2c2b8c1e66279d83a71f2cac2e511986860cd6fd3e75623a53bbaa6c40920c73507ec68a2be8e0a469b7ba5683e76add52c48b686f5f837e352e853b944e8fa64524395a73a2505fa259eebe171a6c344da26f2e2daafb4808925988bef3481e1acc221dee73e467c78d98ea47b165f2971f69df37f10357c92bad5effba1b48495cbee210c77632dd5beadc534142cd2b71ba88e1d6a55db2018299a9278cbe6ef3fe28a821f641438891c83076d452611893b322530cf9e756da54a7e36414d058c45d1c7fb3df5d47417eaf5d1708adbc32353ed84c63c1d99b8684f4e609eae566d2c987de8907eb05b91c3c05f149de777e69326b13647d095f13f0f71f6d26713a15cc619185d10033720182bec21ef4ae60744d2f564ab76eee87c0f4397bda0cc1808e5ff84ea62619d3cc926603d0a0320530bf33b7ac137724b41d85c1f05e5969e0a5a1e55ad0cff710635a5b649fc7792bafd0d25316d96450eb9d94fc4c8637eb8dea37a7517087617f77d42c5a7cdc255b0e9030e2e8c924a34f450ef7df6dca720d9dbc471240dd8e85e4160794ac5207448432fc0a58b02987014187bcb58d9723f39eb65fe74013797b053b7d8f973a2a6670641e1702833198666ba3d112e45d562c4995efe8a126ebf82fd37c585d406db38935db71b3ec89e923db7cf85001f27c8821b8e12a146bc57de880abda9884ead487547d6a5a6081327310c677fa10f6b13e63301e4d9f533096799d19525a801aaf465a40165c65a85263dddba1029a629fb3d6bae7cdc598404aa29ee3fabfbfa83ef9e23ebbd628c730511acd2f14e12cb334a9a905c3b866d6062db994bb238d9f9cd21776ace95e192edefefe57306581737cba836f841e098629a66c276569fdc45f5c3dc9c6ee5acf69ed0da7d2ddfc6dce16460953cefaad1fd1d82aca949c53e77c886c6342beface219c464c8700f98930494fe52cc4cf286f9868322f627f5bf7eecbd556f0d767957043cc6a794bbfa99316e54027ce37ac746a36271c6549d128b03be42cd21d764f96211f9fb85c6b3e57d484b0556fd9e8b7e8ef189976079fd25f00e3fdbb57504b219ab4e9fad443b1f02b37978708310f257161ee203a617873985938e79afb6838509b8139d5077ef8d50d3fd2eaef213d2b8f5fa5d83f6f125b1e86e04e628b18e43d488c82cf3ee298c4d69b8ceeece75d4b11c8b2fbd79bd83cb9d0ea3f1f946a3e0d27cae2133187a552c6d4190a86e74173f2392f7a4dcc8c425f264e8187c02437cee606706adb0b40a14d9c826f723b36dbdc70f69fe7a0dc58426ba26de6a9e89c84a55a6cb7892e7bedc3e651eeb64b0d68a334cec138ac30f02bf91fb804f13618e8ed8ea28f6ef111e1d11df89a2e4d362a3079dd1bb0e9422b0ebc3a651ca3aa10a0cb2431157b8f1375c1b7642f068d266c97d071d34e9a0a9411d91e9445b600af87100c2351fe31bc8702b981bad06f14fc85a226955228f03386b8407f173e88b1478fc7743469d639b1f9b271bce9beda69c657fa7c19cdcf4942816607c75873a3d943bc7c993657ec634056f2b396445a1db93995e8d9987091eb93b837703c4ba63e78b6b7cd8c2800ee7d746cf496cf73ff11776143ec8f4a520d301e9d5748c37a7072474b22b0aba9fc0c2f0206b8e684a286481692544fc22a4f945ad582d2a5ee708e15e693d0656a3c6bbbff6ccb2475f77426b6477ae98897b936ad290c4776b0c4da944b40fc8d82c70df78776b4a18abef06415e5e33aacb2a0039e24e3af1b7ef46a57ea06b2f6d1e9fcdc0cc950962e9b179ce8fce937d45cb2c1ad080cd429f831756972e45f8e8a60209f25a85855f04f862ff841f6779e7dc57d335541d90102af9b346aca848840486c6c61acfb86b1cc67484cc6462947f18121bad2a650e5ebcb422edeea49479f03bb685417e9991ddaa4349c2b173c9bf50a2e22134d40b880a86d7ae958541c20ed26a6778a26134a770d515d0434672157113318f1b9acb8cf0be17200924c86d01d4b4260810660ecda739dff2b4e1f2a9675ec3a49e0225c3a0739152f009a3e51b5cc511b951f78607e84f52feb25eda5a2d52a33ae5def4d1437b2633dcc0c5e804fa1135db03a70c6d00df3ec986014cda09aa53af8ffd42cf38035dce38ec103e35637d9bec19516ddad006724bf60d6e6ab58c2667c3be1daa56595ed24b31fb4646e4cb6637915f026146a2b24ade8986a0d12f9e1a5b58bfac398ae193876a8db803bfbd735396c4999503452f6248390a6fca88e58eec5e5160b4c40f5638d1fc10d912c5e2d60c5be7d1931b736c8cd16e705375bf876d55a42db5c155ef1022faf6fb5bb2a0aa959855e475dc7ff5585d398d701aee2d1c777b7f3ecd20fecbd9b63e447716fd7ef319eab587e2ead942de7cba63ee39c109ecfc977364ce1f26d096f152852ea95ead753333b58093cf588a59d5d5d74dfa4ce3f50e3352dd6edf13a054bcde915e1d73e7af4d2ff9efba52b1e8a051c7d689efae497506758079deeff5b97585356c2fa82680e0b1ae9b5f6603fc87d746de80ae3383e5fa5956d438d67b20e76519cdb3ac1811124c80f96862d9e2f5d973d49dbb59ee8ce447558073e9724d3c1d523b754dce275175f896653f97734b73aecd175a9eec5af886251d0cb9ef82b8b3d171a6eebca4c6b866e0594328b078bb439460bf154479dbd210e59fc6f3f1385a235043c6ede4b0df95bed840bda2886241c1f221a88daaddebb346326c24660f659d65e7412c246b16079c9d89bb7b0f5afc4ed2cdc7a53f1927da481f2198007772eadfa5ab50bf01c3e141b871a01e6354c48c4b8ba1730eaa465248137becbfc21a4f36f8562d0041f3bbb2ffc5577e8396c3e2f0003e1ad14b2316e61195df17ce5d394b83aadb22827c589a85c7ddc3715d36eb62f4c192b5067a70fa0eeb25f1a75aa71b9953622abd3daaa9f3a9e1aa0bcc2ff892277134b52f27804d4ca34274c747fb1f7394c25abd61a29c413b8f2f8fd536978769135a6f03374378d2bb0d47aea73f7115ffa648efdbac0a81d2589cbf39f45db62930b8d87377807a8fd980a69f637104063af321b25569dee28465ab11de2da92dc179385d97ef8a7e352cb11285e6f25af19ea1f32191a7f9e8ed66320a88d4d5c24a9f8c907aaf7ae483181116ddb2d15a3e5bb3dde28f0131969c68bd388fb0df5c274fab329adeb3dae5bb39b25baed42e59695b8921fd6d69c8499f8ddc00063a2e613190f55660541bf660cab165f739d787a4da5c9f047da0a5804fab73e3b821cbaade230e794a34b281528bb323bf5aec3de23dedf7ba7ecfa18668ccbdcf75077139dd4fb5578c47c377eb8dc858fb8068439ff3730f8862ef39ac84c778a2bee11e1bada35e6b6c89554862a7cf9b3ca7c5cf8f8abf390d89b643b5f6ab676e5be81ee2cd584cd4979e42c4caf19d0f90d068aeda86e86db64405b38ae205ad138d917ead216a3256f5324c4d5a7ef3390f4c5a7519bd340e96fae0817d6975595bfbd4fe7c52883d7893015cd8eb6554d49ef675d0be387c62eece2550620c59b0c83baceba245a44a1786b56a4a461849086983fef68dfdffffe1e0a4eea666ec1cc97d43328362c6703d4dfd4b4680ae70eb6b060fe5d1ee4cddc69508d8fe42d2925541b4d080087606e757f7d3032ddfbfd770cffa1ba9e7876ee7a9f65fc587ab5aec29539680b96e4cd3261ae63287d4b90c37a4121c5873b0846d28f4c3a22e337834bc094fbe4c35045b5042a22150ae94a3eaf0b541d3f27ecc9c134625e39ec56d1e786ff06225ffdd1dbcba3dd4138e479f0776b0be91ee19393a7a9371d6aa812f24d82eead303eab2dd31dceb1887f6588b0f51a76898c4f0659db211384c84ed000e0c2d6977cc7235b7ff04d7047340d9abecf027004498a80e038d645e0a3ee808a50930f97ecd961175de9f2d4b18b59affb8d7cb949c80632d6d8447e36eaee010350f5a4a37a7e64f3731e9146209f83e6cb40b65cf0d9de258e9d13f7b8ca2bf2eadbd0e876b910daf6abc2b6136e244b8a282e2deb11600b1a1cd508420a4f61054b701173e874a593a3120d4aac5b9bfaaf5ce130ad0b0aad41a6d57d12b7302335eb3e48d18ea206a4b3d19225f65cf3d671cefe82c14bf048d450990ba2565b1994f2f55f1b7999b1820de030755138446b128fed2d672ddc9ce91fda9eab41e7e403d0e92da66d2406c1cfb70af92fe49809999fb72bc727337b4d2fc268958aa3cebb54327a6ad6772f3b8b980cfb874dcc3dd0b1c6878f1e123c178283375fbf14e3f7796c2d5c1d7a0122379c635f3615ac0066f2578cb92d741c1e0b240697be90e29ac90f27e88dab22a1da58cfee2f4708efb1bbe6bfd55cb11e2bd2923cd587f830aa2d31d3b6dccf1d91160cf56b1930810de966451a9e13760c22b141bce2b0dd3c987e7798a637b12184f9a2a2120d9f1d16500e76e1b00f1d92b1ea080a6e1ef07d0d40ab94c1d7ce12824da418698a09c394cd76e11c8439b6f319893c885f1f0baa6a44e7ff672192b24b9f0656a1a8b1308cff7a87afa0fe75523c23deacc4524447553c478c5f94cf3632911b9af1e775758978299e42452d8670a51be089b444e6aaa0e1ec350cfe391c40f735b80e1dd8a704881ca69e02ef5f7cfd8792147a05798b6560ed7a1387870fdeec4923279dbc865fa977349def9f641c46aeabc93195a98cdc1c673aafee52a4fb65d4b40a130b49874b4763a367e85cf49b9ec54664dc6c6f3a0971286e25a623f2d13517d6d5c0cb20ad3a25a51037527cfaef84f02d25350ac6552eaef021f4824d619523562f4bda62b2e1580fef8ff37890051fc12b87d5b25f2e9d3770043f18fe686e00bdf43010001b4fcc21e069eddd900ae49287aa24cb6eb337fa9dd6c3d4ae02fe6898fe95011567faadeb4c29918ca436d8ad97c364b546d1321152cb4945f6911aa5fd77d3afd4e10603300000000000000013f4aed00d3c0cb67980a145432aeac8ad8ab77182195b09152c1b02b9276e2d7e6f5b34d5b30f0d8f92d1d7b6ac9756b4ed52ac638b655fa9016f49840dec0ff7b4e51b9a1f612483db719213364877b31481aaa371a4f11f6c0ac439b76174e39953f353c97ab6071498ad0c420b3ca68a48a5559f007bd24cefc039001b478cb6619464cd07a0ca362700534a5da85c9d772f004bdcffe014f741e55d2b89ae2b237c97752ab4552ed0d8babc01f986bdd2fb06c9365aa6c47970ef5c026e86258a492f40b4912bd6bd957eec6cead26afdcd342283a8f64137cafcb30dd49cd267f3991d8d4072bb7591201a6e2af095f69ffb0711ca787af1e3608507c25b8af5ce25660a65957b5c645a716239660b2522dd8c29ae770d17c5913571d09ca1b40e88b74e9cbc5234658d321b6774389bd0db80b28aa6f0d6183d11c4060b04b3421b5d75e7e99967814eb73e53456ecdf3c78da3e1fbeca893afdb76b7ce226b41b8bb6a7c2ba6eb681f335dee31bdeb6be9449de70625d5d1ca357040d4d31dd1e551e5eaa3e1f6f26dabe103151f1f261424f6509cda4687c2c83e801908222d3d180dc11f40980c9e5529273e194a451afaf28f0d588a75a8ea4ddd54814e5a0374706545e712333b1d4c8e6b991d362fc37f095466f1fd7748dd585b900617f0eef604ba449341171282f62efe142311677824fd83d396ba40a2ffd6612ce363d6144fc39127d4b73a73a46fa7a56e2cee032d84f0fac49e97e1b55ad91d76c1078e21d2a15bcec0f01609497fc154b4bc4e72155e66ae693199f047ef693fa2445be6e9895d3a96d774a43e49c89b668090c2a46d8bdffc624b132a2421ce50f75991818f00be966593c1d8b3fc589f158375fa76ce0027295957d24dc47a321f90f3c77ecd0f0e15621bbb15e6ecd5ca27aa4eb2dac2ca595144370f3100c084b81b5b3ec519e079a053b350a747edd3f219ea8d78ca164c037a5e69bd73476380d91077c2579ee979bf1c41e18b3c070deea42a17bae35b2da1febc67725d326f32b50779d4fb9aacbde378e0858b850af031cc386741885a8a1b228e3a560d45d322714fe7fcc13aad9a1d1f6afabe42214c60e4db3930046b0caa0996d0eac716ecedee3afcee02a68b21d57932d3577925568b27305885ee2bcb7108a963bcd8b79ef088b421d2854bbd70025ee9c354db1a2051c43da7d43f8eb09e4e9ae67b25760a8a8eb7d42b730c4dc7e3fa6a0c0ab9d55e491419253cfcaeabf8d8e4b18556bb3cd80d2a6acc6ee0fe6845cd98e427948140a403c4f44a76dd6189294bad8ff58ee8782b52a9c2b86624f358660f68f3cd24422b314ea097d0d34317c049f443a8a6801c5316677575168d50a9d93745e1111f5f88a1c5cd31b72b1afdc1a4622997bcb2832df910163d6db0f52d407da7fe304c1a4d1d4280fc50a4a5a015a13d0abd568ae10d033d173aac2224ccf51ab30304abf1627bc538decdf4f099ea16708cce5bec9bad47efd39665bbec5922744e398c9d30c5cfdc633ee068f7e37e782e91ca0830e93dba77ed4cb520a6fd32882428a1c80afb9aefb4a9954a94c537e042516ec1a69a80342ad18e9322aa394651036949c36a1a1916abdb00c807057ee6a43872a5ade1032014d9429805dd64b38e064679a63e7c0634698993212f5c9b9ac4a3af6f04e3d4b0064fb878c262db1bc926730664b26c7c8079626fe879f7d259c4feee8346a9445f7224984a1223cb03c9d98d2d3be011fba53e690f32ec1f5663e01d6bd189ffb2d659df9b8bd5bced7958c498298b53240e3deceae38b766b67bb0a86dbfe23a5aa09e562aa1f48bed1098ba34b4c85d1efd3bdf0d42404f731a1dd401a29274adc35da111cb78edd5f69a92b06fd5528df0d37e606147b7272994a723da078c2c884322f08ee19bab1487ee56ee04370d0fb2542917e679b2accaf86496334366716515bb502d511c958276bf024060b1657c62abbc3579e62de8783763d48b1aa64a2c3687da90b7fde414b9804149e22d48d7033d1cd54b50fc653335abfc1ca12aebcf41f775e33e8307793a9cd62235362db3e74b789a54a4ef4cdadc5077ae5f4ee5be7dfa326bf97518183076059dd95225c8d948d9f7a14644e044332528639984c299b302680d1d70198668be943a92383ae65e7f80fad252b3590b3760da3cef436dba79b26d42dc296eeb4faba0e02e2edd91220d25b807bf575fe4b9ba1528279a03179fd07c2601f3bad45e881262083365ef06187e7d404fcfa33c85743ec081f87289f3d88a74882835ebc2426aff7028323efdcb208ca85b3da9d33b5dc0073fe4ec915a5df355be215339cd17d0b305e6e4312720619c05f73eef05dc714c74328cd9509fb4956f32142ab129a4b9cf1e6de7e084d878aac939e4a77588df1529c718466169210e7aef82a2f452ad625443bdd08d12404ecc7e52048186d9cb8a771ae33b8e278eedf67417e0ab1b73f453e59a2e404170bba25db24aa2bd27be3d9c21fe2ee86c187569f7d827fea7f23acb14d66f77a8a5186d9a700bff9308322e78cf72f253fc0757fe2939735a6f9c7e83cf557cddd637a834a94063cac787f51a00cd13c3357bfbf2d976bbc7453c425395c3a5acd142576abd4db2dec4d4bf861b7605e0d1ee5c7a9c4135c13423d9d56babd5f97a818b837e9eed9973de3a7702ed07469cd36f5fdcd30d10846a6b97cea2afab28bef48347ebd0e8938e3386f2d65aee3c57f49eb03c19bbc0d7fc096776d82e48a3a28dbf30747b531226a0dcdbde86f416573d570f85572f24de9e0afc22d7d3795a39feb5b53cd4d3830ef7e78bda34c857d57aa0c1016135cae76bed1502a21a8e6e63bdc647bbc2d7bddafb1d47800a5758dfd4e20e7c67116ade8afc7f583577f9ae859eed26f07df83b27465a372af2e5af917c72935f876a9cb1ffab23a4f0d79ea018cec51a29c5c3be68bc189e8586ff4f955024f30464ea1ac02fe3ceac4f12d993793b6aca8b17dc5785d5a71a6634643ddc80f3baaaeb7cd6e7f29d3b57e1ab81409d1e8ac86dc9033bc5a68e7a049322b67167eb5a233a33e10853831c6920bbed853051cca3ca10a158027a6ed2acdf56a581df7cacc8285048fb6772145d5e23538a6b571a33f91a80586c7335575ae6d0162dbef7de0938bdba837ed2a56b2fb0b485cd390af859bd8384c6371e7fd4ee3a463c6a4356fcc1f40d0d0a39a53e6579ddb9eb811d7c8d184bfe8c377e0d586a1e22d4de0708febba747cea9ee3199d875d46ce85e904bb554f2ed0539d25392ac79553a29e109e6792d95ba5ff0ce1fd8bdc9027d587fa67061815c1ab77efa97dc9fcdd71422b4a20851d4d8931788f135e244a3e8dda16a8c060b7b1d764097d0b0eece60b7f6db5fec03f56ea6c859100b716acbd051d9b359311285843fd58eaed8403e695cb067842568104d6cbfbea3c49361cd85b061d941d968e20e715228e062c8e1441d7c5f4aa875fe154a7685223ce18b440dd3005f83fc6f4b63899ebdb9b70c42a0e3c356222b76adda9b2a4ac6b52afa1deeba2402a70d889e6f8fd2bb9657fac9be27177d9e1aeed3bfeb08d65cc82dc5b65ab2d22c2e193bcca812862abbed36448f212eb0fb2510e733b4ae3ef098658685a99aa5f90ac6c30c6cacdf2fd152e0e1dd02170ca4b8ec20b354bc1fe30fe3c9701cdcbfedf4edd90015a9acdfa4d95b476ba51ebe54f682abc2cfd3666bee6d768e4b381b1b5473ec5cf8615ec7f4351fe853790f1c3d13dc4f3d9a5598806b597b1bc45e27de98ee411e14fb54ff28a60639e276ccb867f284d4267e73c991a4ce1d1810180497d7a15492cc75312ab5d09d7e0efc24361ae77ab2ef3b4aeb110c2c24f7f3c58e215d8b40cd974642ddfcd41deed610df27c9d71bd2b9c6bd3d3d41a76e916dff7c62c3748cf33483daadf55495b430a6bfc384f3dc41ceaa3105a098bf743d8d99e542c2d8530a2a7b05ec7c3273dfb146ff8e238996d44f19e7e940be4809be63fcf0b03864a75d08cc8ecad5095636d4cb908c4897144ab0149ac5cac2913a7e7e69fc925206bcd5fda34096b061763104509ab98fa6ad6cb3a2a22443f2fe4cbef7479b773b3dc5b8f5d470088c6528b1421ae8550f0ff356cc0c36b5506ba0e127ec2efd6e9999022c9ea65f32b8c9c08d5a1b1fd81fd43576e6b103a22285d8396b76601f5923632ab9d584cf82044d2f30cfb69748322371b484736d8e9e03d8a1593264c21ad36c25b004319747036b8472cb76100f09f30f301aba3fdbace472d3dd49961f987cbbe68c77e989b5af04cb8d1d330e3b0efac20e8bbe6f93bd593493a63bafe12dec1767da4be727b70bf3cb8417218dd6037d6e13d0c4bc52c696afe7b5ef8dd06c3e60ad7bd7e43d8e21e5441a998a1cf437e55014ae9c0bcba0e684ac06cb83b5c06c8e61a50a953eb45156fee71a472c48e5bd1da87d992c05912de71e71f03e8cf295e21dd4aec98dde823f4a8fe80f228bfcfd1d4e191b49fee85cc0ff5fa65757b23557d07474046429c6d5dd7044c29a672ca93325f8e1ddc30a154e443096f83f3474218ce576ee7b24a0d0c1b81e6e9f2ce277dc2a7845d379c10cd69e2deb7c86b7d8b52b964f1eacb483aebbf4f30d7b0dfa9e7e5a20bfc910e1338eafacaae4ebfed9ddbf6483e93923e79b982cbfd580e30d4df519fa5659b4cbdb948a60f97c388760a84bfe6f3333b9cd021c7885bad674b8ba54c0099f159ae9da52fa9b74bcc6a4de3faca7b4148dfcb002d51f8b4d4f9a69dc15dcd383a5568cd20154d055d02cf96c933ddd0e3c684c9701cfd3530ceadd6f3ea3c7e1fa1d9b162b3dd008af010b7153a07d4ff19e9cab281740a21f1ce3756e83025cef11cf80e9bc881e1f305ae8c928b01239fc8ab12582002a227d92667b7e0024f1174e6ac0246af21d9f6d3646578585a27bd028a21863002041798478882a147955bc19f759bead238c9f115f5860e7630bc260e654043eee2a73e8e3c0b2715330e82cdfd55a5bfd43678b5b8083d8673af94a67ccc4746b428c3520133f956b02dd6554b27b5e20e6098eacff0b66b553933f97c257a7af37c99a38f6b01ca7363822cac8bdea603a5c3a6e925080e811472b80b2e3ca48bff7ec6f38ebb80c635d47e9af6c7f2358d6117366e79544f49d0cae1bca42b69c0d204c7628a25f24922ba2a26859d09398c13dfb491f3a0948bc4435e077ac9bff553de43f56a0115917ac80f71d0fc724cf70eacbee02d057a581293ccc3df551ca5877fcf1fc54b00ed3ab7855710a389d9480eff661cf9f27f7fc490b6e097284d63c425cc7621ebae99cd4f25b5cdb945b6507b8c73ac61851f889f626604feb0ea3fc344f72e4133c433f67833edeb14bc0960a657ce76970fd0fe988a8097d45b6511535c4600d73a66314249705d255df3463b04424ef9df76788be55b2c0ae67309a7c8bf0ec5841537eaf6d8decc7bd50b0d9b119413b1a48a3326217ee3d465c6e2e0d725cdc03b79d842788ea21bc6e144e5d6af71972750ded9f448db37008ffd20557cb30edd41615f69834b8c4228e9d0447f6731865a9fdbc916acbbaacf247e3645c6d66c4cc447ba0934aaa2e154245f9d5d80d2b18007479a0c17d404120fadaa7faabf1ecbbe0da6bee690e2cef7112fdb7696bb02defef9ac5f757b5230691bf595f852c30a479219b0394d617546ee4a129291408ccbb4fc8c64853cd3ad5e0f5fcc083e5c80c309e0304b37800e570571e7aaf733b03e3eb15148202e2184e17c843b65d1d8b1073c76c6afdb3b89b42a20f1eb0ee6e7e96ed35ab703f44b0c70000").unwrap();
    static ref TEST_P2TR_ADDR: Address = Address::from_str("tlq1pq0wqu32e2xacxeyps22x8gjre4qk3u6r70pj4r62hzczxeyz8x3yxucrpn79zy28plc4x37aaf33kwt6dz2nn6gtkya6h02mwpzy4eh69zzexq7cf5y5").unwrap();
}

impl MockWallet {
    pub(crate) fn new(user_signer: Arc<Box<dyn Signer>>) -> Result<Self> {
        let signer = crate::signer::SdkLwkSigner::new(user_signer.clone())?;
        Ok(Self {
            signer,
            utxos: Mutex::new(vec![]),
        })
    }

    pub(crate) fn set_utxos(&self, utxos: Vec<WalletTxOut>) -> &Self {
        *self.utxos.lock().unwrap() = utxos;
        self
    }
}

#[sdk_macros::async_trait]
impl OnchainWallet for MockWallet {
    async fn transactions(&self) -> Result<Vec<WalletTx>, PaymentError> {
        Ok(vec![])
    }

    async fn transactions_by_tx_id(&self) -> Result<HashMap<Txid, WalletTx>, PaymentError> {
        Ok(Default::default())
    }

    async fn asset_utxos(&self, _asset_id: &AssetId) -> Result<Vec<WalletTxOut>, PaymentError> {
        Ok(self.utxos.lock().unwrap().clone())
    }

    async fn build_tx(
        &self,
        _fee_rate: Option<f32>,
        _recipient_address: &str,
        _asset_id: &str,
        _amount_sat: u64,
    ) -> Result<Transaction, PaymentError> {
        Ok(TEST_LIQUID_TX.clone())
    }

    async fn build_drain_tx(
        &self,
        _fee_rate_sats_per_kvb: Option<f32>,
        _recipient_address: &str,
        _enforce_amount_sat: Option<u64>,
    ) -> Result<Transaction, PaymentError> {
        Ok(TEST_LIQUID_TX.clone())
    }

    async fn build_tx_or_drain_tx(
        &self,
        _fee_rate_sats_per_kvb: Option<f32>,
        _recipient_address: &str,
        _asset_id: &str,
        _amount_sat: u64,
    ) -> Result<Transaction, PaymentError> {
        Ok(TEST_LIQUID_TX.clone())
    }

    async fn sign_pset(&self, _pset: &mut PartiallySignedTransaction) -> Result<(), PaymentError> {
        Ok(())
    }

    async fn next_unused_address(&self) -> Result<Address, PaymentError> {
        Ok(TEST_P2TR_ADDR.clone())
    }

    async fn next_unused_change_address(&self) -> Result<Address, PaymentError> {
        Ok(TEST_P2TR_ADDR.clone())
    }

    async fn tip(&self) -> u32 {
        0
    }

    fn pubkey(&self) -> Result<String> {
        Ok(self.signer.xpub()?.public_key.to_string())
    }

    fn fingerprint(&self) -> Result<String> {
        Ok(self.signer.fingerprint()?.to_hex())
    }

    fn sign_message(&self, _message: &str) -> Result<String> {
        unimplemented!()
    }

    fn check_message(&self, _message: &str, _pubkey: &str, _signature: &str) -> Result<bool> {
        unimplemented!()
    }

    async fn full_scan(&self) -> Result<(), PaymentError> {
        Ok(())
    }
}

pub(crate) struct MockSigner {
    xprv: Xpriv,
    secp: Secp256k1<All>,
    keypair: Keypair,
}

impl MockSigner {
    pub(crate) fn new() -> Result<Self, NewError> {
        let secp = Secp256k1::new();
        let mnemonic = Mnemonic::generate(12)?;
        let seed = mnemonic.to_seed("");
        let xprv = Xpriv::new_master(bitcoin::Network::Testnet, &seed)?;
        let keypair = xprv.to_keypair(&secp);

        Ok(Self {
            xprv,
            secp,
            keypair,
        })
    }
}

impl Signer for MockSigner {
    fn xpub(&self) -> Result<Vec<u8>, SignerError> {
        Ok(Xpub::from_priv(&self.secp, &self.xprv).encode().to_vec())
    }

    fn derive_xpub(&self, derivation_path: String) -> Result<Vec<u8>, SignerError> {
        let der: DerivationPath = derivation_path.parse()?;
        let derived = self.xprv.derive_priv(&self.secp, &der)?;
        Ok(Xpub::from_priv(&self.secp, &derived).encode().to_vec())
    }

    fn sign_ecdsa(&self, _msg: Vec<u8>, _derivation_path: String) -> Result<Vec<u8>, SignerError> {
        todo!()
    }

    fn sign_ecdsa_recoverable(&self, msg: Vec<u8>) -> Result<Vec<u8>, SignerError> {
        let msg: Message = Message::from_digest_slice(msg.as_slice())
            .map_err(|e| SignerError::Generic { err: e.to_string() })?;
        // Get message signature and encode to zbase32
        let recoverable_sig = self
            .secp
            .sign_ecdsa_recoverable(&msg, &self.keypair.secret_key());
        let (recovery_id, sig) = recoverable_sig.serialize_compact();
        let mut complete_signature = vec![31 + recovery_id.to_i32() as u8];
        complete_signature.extend_from_slice(&sig);
        Ok(complete_signature)
    }

    fn slip77_master_blinding_key(&self) -> Result<Vec<u8>, SignerError> {
        let blinding_key: MasterBlindingKey = self.keypair.secret_key().secret_bytes().into();
        Ok(blinding_key.as_bytes().to_vec())
    }

    fn hmac_sha256(&self, _msg: Vec<u8>, _derivation_path: String) -> Result<Vec<u8>, SignerError> {
        todo!()
    }

    fn ecies_encrypt(&self, msg: Vec<u8>) -> Result<Vec<u8>, SignerError> {
        let rc_pub = self.keypair.public_key().to_public_key().to_bytes();
        ecies::encrypt(&rc_pub, &msg).map_err(|err| SignerError::Generic {
            err: format!("Could not encrypt data: {err}"),
        })
    }

    fn ecies_decrypt(&self, msg: Vec<u8>) -> Result<Vec<u8>, SignerError> {
        let rc_prv = self.keypair.secret_bytes();
        ecies::decrypt(&rc_prv, &msg).map_err(|err| SignerError::Generic {
            err: format!("Could not decrypt data: {err}"),
        })
    }
}
